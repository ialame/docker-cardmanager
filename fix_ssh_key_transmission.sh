#!/bin/bash

# üîë Correction Transmission Cl√© SSH
# R√©sout le probl√®me "Permission denied (publickey)" dans Docker

echo "üîë Correction Transmission Cl√© SSH"
echo "=================================="

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üéØ Probl√®me identifi√© : Cl√© SSH non transmise au conteneur${NC}"
echo -e "${YELLOW}üìã Solution : Transmission explicite de la cl√© SSH${NC}"
echo ""

# 1. V√©rification des cl√©s SSH disponibles
echo -e "${BLUE}üîç V√©rification des cl√©s SSH disponibles...${NC}"

SSH_KEY_FILE=""
SSH_KEY_CANDIDATES=(
    ~/.ssh/bitbucket_ed25519
    ~/.ssh/id_ed25519
    ~/.ssh/id_rsa
    ~/.ssh/bitbucket_rsa
)

for key_file in "${SSH_KEY_CANDIDATES[@]}"; do
    if [ -f "$key_file" ]; then
        echo -e "${GREEN}‚úÖ Trouv√© : $key_file${NC}"
        if [ -z "$SSH_KEY_FILE" ]; then
            SSH_KEY_FILE="$key_file"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è Non trouv√© : $key_file${NC}"
    fi
done

if [ -z "$SSH_KEY_FILE" ]; then
    echo -e "${RED}‚ùå Aucune cl√© SSH trouv√©e !${NC}"
    echo -e "${YELLOW}üí° Cr√©ez une cl√© SSH :${NC}"
    echo "   ssh-keygen -t ed25519 -C 'votre.email@domain.com'"
    echo "   ssh-add ~/.ssh/id_ed25519"
    echo "   # Puis ajoutez ~/.ssh/id_ed25519.pub sur Bitbucket"
    exit 1
fi

echo -e "${GREEN}üîë Cl√© SSH s√©lectionn√©e : $SSH_KEY_FILE${NC}"

# 2. Test de connexion SSH
echo -e "${BLUE}üß™ Test de connexion SSH...${NC}"
if ssh -T git@bitbucket.org -o ConnectTimeout=5 -o BatchMode=yes 2>&1 | grep -q "logged in as"; then
    echo -e "${GREEN}‚úÖ SSH fonctionne localement${NC}"
else
    echo -e "${RED}‚ùå SSH ne fonctionne pas localement${NC}"
    echo -e "${YELLOW}üí° Solutions :${NC}"
    echo "   1. V√©rifiez que la cl√© est ajout√©e √† ssh-agent :"
    echo "      eval \$(ssh-agent -s)"
    echo "      ssh-add $SSH_KEY_FILE"
    echo "   2. V√©rifiez que la cl√© publique est sur Bitbucket :"
    echo "      cat ${SSH_KEY_FILE}.pub"
    echo "   3. Testez manuellement : ssh -T git@bitbucket.org"
    exit 1
fi

# 3. Encoder la cl√© SSH pour Docker
echo -e "${BLUE}üîß Encodage de la cl√© SSH pour Docker...${NC}"
SSH_PRIVATE_KEY_ENCODED=$(cat "$SSH_KEY_FILE" | base64 -w 0 2>/dev/null || cat "$SSH_KEY_FILE" | base64)

if [ -z "$SSH_PRIVATE_KEY_ENCODED" ]; then
    echo -e "${RED}‚ùå Erreur lors de l'encodage de la cl√© SSH${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Cl√© SSH encod√©e (${#SSH_PRIVATE_KEY_ENCODED} caract√®res)${NC}"

# 4. Mise √† jour du .env avec la cl√© SSH
echo -e "${BLUE}üìù Mise √† jour du fichier .env...${NC}"

# Sauvegarder le .env existant
if [ -f ".env" ]; then
    cp .env .env.backup
    echo -e "${GREEN}üíæ .env sauvegard√© vers .env.backup${NC}"
fi

# Lire la configuration existante ou cr√©er une nouvelle
if [ -f ".env" ]; then
    source .env
fi

# Cr√©er/Mettre √† jour le .env avec la cl√© SSH
cat > .env << EOF
# üåê Configuration SSH Bitbucket
MASON_REPO_URL=${MASON_REPO_URL:-git@bitbucket.org:pcafxc/mason.git}
PAINTER_REPO_URL=${PAINTER_REPO_URL:-git@bitbucket.org:pcafxc/painter.git}
GESTIONCARTE_REPO_URL=${GESTIONCARTE_REPO_URL:-git@bitbucket.org:pcafxc/gestioncarte.git}

# üåø Branches
MASON_BRANCH=${MASON_BRANCH:-feature/RETRIEVER-511}
PAINTER_BRANCH=${PAINTER_BRANCH:-feature/card-manager-511}
GESTIONCARTE_BRANCH=${GESTIONCARTE_BRANCH:-feature/card-manager-511}

# üîë Cl√© SSH (encod√©e en base64)
SSH_PRIVATE_KEY=${SSH_PRIVATE_KEY_ENCODED}

# üîë Token Git (optionnel)
GIT_TOKEN=${GIT_TOKEN:-}

# üóÑÔ∏è Configuration Base de Donn√©es
DB_NAME=${DB_NAME:-dev}
DB_USER=${DB_USER:-ia}
DB_PASSWORD=${DB_PASSWORD:-foufafou}
DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root_password}

# üîå Ports
GESTIONCARTE_PORT=${GESTIONCARTE_PORT:-8080}
PAINTER_PORT=${PAINTER_PORT:-8081}
NGINX_PORT=${NGINX_PORT:-8082}
MARIADB_PORT=${MARIADB_PORT:-3307}

# üñºÔ∏è Configuration Painter
PAINTER_IMAGES_PATH=/app/images

# üîß Configuration Spring
SPRING_PROFILES_ACTIVE=docker
SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/${DB_NAME}
SPRING_DATASOURCE_USERNAME=${DB_USER}
SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
EOF

echo -e "${GREEN}‚úÖ Fichier .env mis √† jour avec la cl√© SSH${NC}"

# 5. V√©rification de la transmission dans docker-compose.yml
echo -e "${BLUE}üê≥ V√©rification du docker-compose.yml...${NC}"

# V√©rifier que SSH_PRIVATE_KEY est bien dans les args
if grep -q "SSH_PRIVATE_KEY" docker-compose.yml; then
    echo -e "${GREEN}‚úÖ SSH_PRIVATE_KEY trouv√© dans docker-compose.yml${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è SSH_PRIVATE_KEY manquant dans docker-compose.yml${NC}"
    echo -e "${BLUE}üìù Mise √† jour du docker-compose.yml...${NC}"

    # Backup du docker-compose.yml
    cp docker-compose.yml docker-compose.yml.backup

    # Cr√©er un docker-compose.yml corrig√©
    cat > docker-compose.yml << 'COMPOSE_EOF'
services:
  # üóÑÔ∏è Base de donn√©es MariaDB
  mariadb:
    image: mariadb:11.0
    container_name: cardmanager-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${MARIADB_PORT:-3307}:3306"
    volumes:
      - ./volumes/db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 30s

  # üé® Service Painter (Images)
  painter:
    build:
      context: .
      dockerfile: docker/painter/Dockerfile
      args:
        MASON_REPO_URL: ${MASON_REPO_URL}
        PAINTER_REPO_URL: ${PAINTER_REPO_URL}
        MASON_BRANCH: ${MASON_BRANCH}
        PAINTER_BRANCH: ${PAINTER_BRANCH}
        SSH_PRIVATE_KEY: ${SSH_PRIVATE_KEY}
        GIT_TOKEN: ${GIT_TOKEN}
    container_name: cardmanager-painter
    restart: unless-stopped
    ports:
      - "${PAINTER_PORT:-8081}:8081"
    volumes:
      - ./volumes/images:/app/images
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/${DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      PAINTER_IMAGES_PATH: /app/images
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 60s

  # üñºÔ∏è Service GestionCarte (Application principale)
  gestioncarte:
    build:
      context: .
      dockerfile: docker/gestioncarte/Dockerfile
      args:
        MASON_REPO_URL: ${MASON_REPO_URL}
        PAINTER_REPO_URL: ${PAINTER_REPO_URL}
        GESTIONCARTE_REPO_URL: ${GESTIONCARTE_REPO_URL}
        MASON_BRANCH: ${MASON_BRANCH}
        PAINTER_BRANCH: ${PAINTER_BRANCH}
        GESTIONCARTE_BRANCH: ${GESTIONCARTE_BRANCH}
        SSH_PRIVATE_KEY: ${SSH_PRIVATE_KEY}
        GIT_TOKEN: ${GIT_TOKEN}
    container_name: cardmanager-gestioncarte
    restart: unless-stopped
    ports:
      - "${GESTIONCARTE_PORT:-8080}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/${DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      PAINTER_SERVICE_URL: http://painter:8081
    depends_on:
      mariadb:
        condition: service_healthy
      painter:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 60s

  # ‚ö° Nginx (Serveur d'images statiques)
  nginx:
    image: nginx:alpine
    container_name: cardmanager-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-8082}:80"
    volumes:
      - ./volumes/images:/var/www/html/images:ro
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - painter
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      timeout: 5s
      retries: 3
      interval: 30s

# üíæ Volumes persistants
volumes:
  db_data:
    driver: local
  images:
    driver: local
COMPOSE_EOF

    echo -e "${GREEN}‚úÖ docker-compose.yml mis √† jour${NC}"
fi

# 6. Script de build final
echo -e "${BLUE}üöÄ Cr√©ation du script de build final...${NC}"
cat > build-with-ssh-transmission.sh << 'EOF'
#!/bin/bash

# üîë Build CardManager avec Transmission SSH

echo "üîë Build CardManager avec Transmission SSH"
echo "==========================================="

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# V√©rifications
if [ ! -f ".env" ]; then
    echo -e "${RED}‚ùå Fichier .env manquant !${NC}"
    echo -e "${YELLOW}üí° Lancez d'abord : ./fix_ssh_key_transmission.sh${NC}"
    exit 1
fi

# Source de la configuration
source .env

# V√©rifier que SSH_PRIVATE_KEY est d√©fini
if [ -z "$SSH_PRIVATE_KEY" ]; then
    echo -e "${RED}‚ùå SSH_PRIVATE_KEY non d√©finie dans .env !${NC}"
    echo -e "${YELLOW}üí° Lancez : ./fix_ssh_key_transmission.sh${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Cl√© SSH trouv√©e (${#SSH_PRIVATE_KEY} caract√®res)${NC}"

# Affichage de la configuration
echo -e "${BLUE}üìã Configuration :${NC}"
echo "   Mason: $MASON_REPO_URL"
echo "   Painter: $PAINTER_REPO_URL"
echo "   GestionCarte: $GESTIONCARTE_REPO_URL"
echo "   SSH: Cl√© encod√©e pr√™te"

# Test SSH local (optionnel mais informatif)
echo -e "${BLUE}üß™ Test SSH local...${NC}"
if ssh -T git@bitbucket.org -o ConnectTimeout=3 -o BatchMode=yes 2>&1 | grep -q "logged in as"; then
    echo -e "${GREEN}‚úÖ SSH local OK${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è SSH local probl√©matique (mais Docker utilisera sa propre cl√©)${NC}"
fi

# Nettoyer les conteneurs pr√©c√©dents
echo -e "${BLUE}üßπ Nettoyage...${NC}"
docker-compose down --volumes --remove-orphans 2>/dev/null

# Build avec transmission SSH
echo -e "${BLUE}üî® Build avec transmission SSH...${NC}"
echo -e "${YELLOW}üìã La cl√© SSH sera transmise via SSH_PRIVATE_KEY${NC}"

if docker-compose build --no-cache; then
    echo ""
    echo -e "${GREEN}üéâ BUILD R√âUSSI avec SSH !${NC}"
    echo ""
    echo -e "${BLUE}üöÄ D√©marrage des services...${NC}"
    docker-compose up -d

    echo ""
    echo -e "${GREEN}‚úÖ Services d√©marr√©s !${NC}"
    echo "   üì± GestionCarte : http://localhost:${GESTIONCARTE_PORT:-8080}"
    echo "   üé® Painter : http://localhost:${PAINTER_PORT:-8081}"
    echo "   üñºÔ∏è Images statiques : http://localhost:${NGINX_PORT:-8082}"
    echo "   üóÑÔ∏è MariaDB : localhost:${MARIADB_PORT:-3307}"

    echo ""
    echo -e "${BLUE}üîç Status des services :${NC}"
    docker-compose ps

else
    echo ""
    echo -e "${RED}‚ùå BUILD √âCHOU√â !${NC}"
    echo ""
    echo -e "${YELLOW}üîç Diagnostics :${NC}"
    echo "1. V√©rifiez les logs ci-dessus"
    echo "2. La cl√© SSH est transmise : SSH_PRIVATE_KEY=${#SSH_PRIVATE_KEY} caract√®res"
    echo "3. V√©rifiez que la cl√© publique est sur Bitbucket"
    echo "4. Relancez si probl√®me temporaire"
    exit 1
fi
EOF

chmod +x build-with-ssh-transmission.sh
echo -e "${GREEN}‚úÖ Script de build SSH cr√©√©${NC}"

# R√©sum√©
echo ""
echo -e "${GREEN}üéâ CORRECTION SSH TERMIN√âE !${NC}"
echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo ""
echo -e "${YELLOW}üìã Ce qui a √©t√© corrig√© :${NC}"
echo "   ‚úÖ Cl√© SSH d√©tect√©e et encod√©e"
echo "   ‚úÖ SSH_PRIVATE_KEY ajout√©e au .env"
echo "   ‚úÖ docker-compose.yml mis √† jour"
echo "   ‚úÖ Arguments SSH transmis aux Dockerfiles"
echo "   ‚úÖ Script de build SSH cr√©√©"
echo ""
echo -e "${YELLOW}üîë Cl√© SSH utilis√©e :${NC} $SSH_KEY_FILE"
echo -e "${YELLOW}üìÅ Cl√© publique :${NC} ${SSH_KEY_FILE}.pub"
echo ""
echo -e "${YELLOW}üöÄ Pour continuer :${NC}"
echo "   ./build-with-ssh-transmission.sh"
echo ""
echo -e "${YELLOW}üí° Si le probl√®me persiste :${NC}"
echo "   1. V√©rifiez que votre cl√© publique est sur Bitbucket"
echo "   2. Testez : ssh -T git@bitbucket.org"
echo "   3. V√©rifiez les permissions : chmod 600 $SSH_KEY_FILE"
echo ""
echo -e "${GREEN}La cl√© SSH devrait maintenant √™tre transmise √† Docker ! üéØ${NC}"